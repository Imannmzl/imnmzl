<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Force Clear Cache - Chat Room Realtime</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        .log { background: #f8f9fa; padding: 1rem; border-radius: 8px; font-family: monospace; max-height: 400px; overflow-y: auto; }
        .log-item { margin: 0.25rem 0; padding: 0.25rem; }
        .success { color: #28a745; }
        .error { color: #dc3545; }
        .warning { color: #ffc107; }
        .info { color: #17a2b8; }
    </style>
</head>
<body>
    <div class="container mt-4">
        <div class="row justify-content-center">
            <div class="col-md-8">
                <div class="card">
                    <div class="card-header">
                        <h4>üßπ Force Clear Cache & Data</h4>
                        <small class="text-muted">Script untuk membersihkan semua cache dan data yang mungkin menyebabkan redirect salah</small>
                    </div>
                    <div class="card-body">
                        <div class="alert alert-warning">
                            <strong>‚ö†Ô∏è Peringatan:</strong> Script ini akan membersihkan semua data yang tersimpan di browser untuk domain ini.
                        </div>
                        
                        <button id="forceClearBtn" class="btn btn-danger btn-lg w-100 mb-3">
                            üßπ Force Clear All Data
                        </button>
                        
                        <div class="log" id="logContainer">
                            <div class="log-item info">Ready to clear cache and data...</div>
                        </div>
                        
                        <hr>
                        
                        <div class="text-center">
                            <a href="login.php" class="btn btn-primary">‚Üê Kembali ke Login</a>
                            <a href="debug-url.php" class="btn btn-outline-secondary">Debug URL Info</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        const logContainer = document.getElementById('logContainer');
        const forceClearBtn = document.getElementById('forceClearBtn');
        
        function log(message, type = 'info') {
            const logItem = document.createElement('div');
            logItem.className = `log-item ${type}`;
            logItem.textContent = `[${new Date().toLocaleTimeString()}] ${message}`;
            logContainer.appendChild(logItem);
            logContainer.scrollTop = logContainer.scrollHeight;
        }
        
        async function clearAllData() {
            forceClearBtn.disabled = true;
            forceClearBtn.innerHTML = 'üîÑ Clearing...';
            
            try {
                log('Starting force clear process...', 'info');
                
                // 1. Clear localStorage
                log('Clearing localStorage...', 'info');
                const localStorageKeys = Object.keys(localStorage);
                localStorage.clear();
                log(`Cleared ${localStorageKeys.length} localStorage items`, 'success');
                
                // 2. Clear sessionStorage
                log('Clearing sessionStorage...', 'info');
                const sessionStorageKeys = Object.keys(sessionStorage);
                sessionStorage.clear();
                log(`Cleared ${sessionStorageKeys.length} sessionStorage items`, 'success');
                
                // 3. Clear IndexedDB
                log('Clearing IndexedDB...', 'info');
                if ('indexedDB' in window) {
                    try {
                        const databases = await indexedDB.databases();
                        for (const db of databases) {
                            await new Promise((resolve, reject) => {
                                const deleteReq = indexedDB.deleteDatabase(db.name);
                                deleteReq.onerror = () => reject(deleteReq.error);
                                deleteReq.onsuccess = () => resolve();
                            });
                        }
                        log(`Cleared ${databases.length} IndexedDB databases`, 'success');
                    } catch (error) {
                        log(`IndexedDB clear error: ${error.message}`, 'warning');
                    }
                } else {
                    log('IndexedDB not supported', 'warning');
                }
                
                // 4. Clear Cache Storage
                log('Clearing Cache Storage...', 'info');
                if ('caches' in window) {
                    try {
                        const cacheNames = await caches.keys();
                        await Promise.all(cacheNames.map(cacheName => caches.delete(cacheName)));
                        log(`Cleared ${cacheNames.length} cache storages`, 'success');
                    } catch (error) {
                        log(`Cache clear error: ${error.message}`, 'warning');
                    }
                } else {
                    log('Cache Storage not supported', 'warning');
                }
                
                // 5. Clear Service Worker
                log('Clearing Service Workers...', 'info');
                if ('serviceWorker' in navigator) {
                    try {
                        const registrations = await navigator.serviceWorker.getRegistrations();
                        await Promise.all(registrations.map(registration => registration.unregister()));
                        log(`Unregistered ${registrations.length} service workers`, 'success');
                    } catch (error) {
                        log(`Service Worker clear error: ${error.message}`, 'warning');
                    }
                } else {
                    log('Service Worker not supported', 'warning');
                }
                
                // 6. Clear cookies (if possible)
                log('Attempting to clear cookies...', 'info');
                try {
                    document.cookie.split(";").forEach(function(c) { 
                        document.cookie = c.replace(/^ +/, "").replace(/=.*/, "=;expires=" + new Date().toUTCString() + ";path=/"); 
                    });
                    log('Cookies cleared', 'success');
                } catch (error) {
                    log(`Cookie clear error: ${error.message}`, 'warning');
                }
                
                // 7. Force reload with cache bypass
                log('All data cleared successfully!', 'success');
                log('Reloading page with cache bypass...', 'info');
                
                setTimeout(() => {
                    // Force reload with cache bypass
                    window.location.reload(true);
                }, 2000);
                
            } catch (error) {
                log(`Error during clear process: ${error.message}`, 'error');
                console.error('Force clear error:', error);
            } finally {
                forceClearBtn.disabled = false;
                forceClearBtn.innerHTML = 'üßπ Force Clear All Data';
            }
        }
        
        forceClearBtn.addEventListener('click', clearAllData);
        
        // Log current page info
        log(`Current URL: ${window.location.href}`, 'info');
        log(`Origin: ${window.location.origin}`, 'info');
        log(`Pathname: ${window.location.pathname}`, 'info');
        
        // Check for stored data
        const localStorageData = Object.keys(localStorage);
        const sessionStorageData = Object.keys(sessionStorage);
        
        if (localStorageData.length > 0) {
            log(`Found ${localStorageData.length} localStorage items: ${localStorageData.join(', ')}`, 'warning');
        }
        
        if (sessionStorageData.length > 0) {
            log(`Found ${sessionStorageData.length} sessionStorage items: ${sessionStorageData.join(', ')}`, 'warning');
        }
        
        // Check for any redirect-related data
        const redirectKeys = [...localStorageData, ...sessionStorageData].filter(key => 
            key.toLowerCase().includes('redirect') || 
            key.toLowerCase().includes('url') || 
            key.toLowerCase().includes('location')
        );
        
        if (redirectKeys.length > 0) {
            log(`Found redirect-related data: ${redirectKeys.join(', ')}`, 'warning');
        }
    </script>
</body>
</html>